angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$locale",function(d,f){var e=d.eventSources;var g=d.calendarWatchEvent?d.calendarWatchEvent:angular.noop;var c=function(i){return function(){if(d.$root.$$phase){return i.apply(this,arguments)}var j=arguments;var k=this;return d.$root.$apply(function(){return i.apply(k,j)})}};var b=1;this.eventFingerprint=function(k){if(!k._id){k._id=b++}var j=g({event:k})||"";var l=moment.isMoment(k.start)?k.start.unix():(k.start?moment(k.start).unix():"");var i=moment.isMoment(k.end)?k.end.unix():(k.end?moment(k.end).unix():"");return[k._id,k.id||"",k.title||"",k.url||"",l,i,k.allDay||"",k.className||"",j].join("")};var a=1;var h=1;this.sourceFingerprint=function(k){var i=""+(k.__id||(k.__id=a++));var j=angular.isObject(k)&&k.events;if(j){i=i+"-"+(j.__id||(j.__id=h++))}return i};this.allEvents=function(){return Array.prototype.concat.apply([],(e||[]).reduce(function(j,k){if(angular.isArray(k)){j.push(k)}else{if(angular.isObject(k)&&angular.isArray(k.events)){var i=Object.keys(k).filter(function(l){return(l!=="_id"&&l!=="events")});k.events.forEach(function(l){angular.extend(l,i)});j.push(k.events)}}return j},[]))};this.changeWatcher=function(i,l){var j;var m=function(){return((angular.isFunction(i)?i():i)||[]).reduce(function(p,r){var q=l(r);n[q]=r;p.push(q);return p},[])};var k=function(q,p){var r=(p||[]).reduce(function(s,t){s[t]=true;return s},Object.create(null));return(q||[]).filter(function(s){return !r[s]})};var n={};var o=function(y,w){var t;var r;var s={};var p=k(w,y);for(t=0;t<p.length;t++){var u=p[t];var q=n[u];delete n[u];var v=l(q);if(v===u){j.onRemoved(q)}else{s[v]=u;j.onChanged(q)}}var x=k(y,w);for(t=0;t<x.length;t++){r=x[t];if(!s[r]){j.onAdded(n[r])}}};j={subscribe:function(q,p){q.$watch(m,function(t,s){var r=!(p&&p(t,s)===false);if(r){o(t,s)}},true)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop};return j};this.getFullCalendarConfig=function(j,k){var i={};angular.extend(i,k);angular.extend(i,j);angular.forEach(i,function(m,l){if(typeof m==="function"){i[l]=c(i[l])}});return i};this.getLocaleConfig=function(i){if(!i.lang&&!i.locale||i.useNgLocale){var k=function(l){return(Object.keys(l)||[]).reduce(function(m,n){m.push(l[n]);return m},[])};var j=f.DATETIME_FORMATS;return{monthNames:k(j.MONTH),monthNamesShort:k(j.SHORTMONTH),dayNames:k(j.DAY),dayNamesShort:k(j.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(a){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(k,f,i,e){var b=k.eventSources;var d=false;var c;var h=e.changeWatcher(b,e.sourceFingerprint);var j=e.changeWatcher(e.allEvents,e.eventFingerprint);var l=null;function g(){var p=i.uiCalendar?k.$parent.$eval(i.uiCalendar):{};var n=e.getFullCalendarConfig(p,a);var m=e.getLocaleConfig(n);angular.extend(m,n);l={eventSources:b};angular.extend(l,m);l.calendars=null;var r={};for(var q in l){if(q!=="eventSources"){r[q]=l[q]}}return JSON.stringify(r)}k.destroyCalendar=function(){if(c&&c.fullCalendar){c.fullCalendar("destroy")}if(i.calendar){c=a.calendars[i.calendar]=angular.element(f).html("")}else{c=angular.element(f).html("")}};k.initCalendar=function(){if(!c){c=$(f).html("")}c.fullCalendar(l);if(i.calendar){a.calendars[i.calendar]=c}};k.$on("$destroy",function(){k.destroyCalendar()});h.onAdded=function(m){if(c&&c.fullCalendar){c.fullCalendar(l);if(i.calendar){a.calendars[i.calendar]=c}c.fullCalendar("addEventSource",m);d=true}};h.onRemoved=function(m){if(c&&c.fullCalendar){c.fullCalendar("removeEventSource",m);d=true}};h.onChanged=function(){if(c&&c.fullCalendar){c.fullCalendar("refetchEvents");d=true}};j.onAdded=function(m){if(c&&c.fullCalendar){c.fullCalendar("renderEvent",m,!!m.stick)}};j.onRemoved=function(m){if(c&&c.fullCalendar){c.fullCalendar("removeEvents",m._id)}};j.onChanged=function(o){if(c&&c.fullCalendar){var n=c.fullCalendar("clientEvents",o._id);for(var m=0;m<n.length;m++){var p=n[m];p=angular.extend(p,o);c.fullCalendar("updateEvent",p)}}};h.subscribe(k);j.subscribe(k,function(){if(d===true){d=false;return false}});k.$watch(g,function(n,m){if(n!==m){k.destroyCalendar();k.initCalendar()}else{if((n&&angular.isUndefined(c))){k.initCalendar()}}})}}}]);